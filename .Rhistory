source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/R/EnrichmentSet-class.R", echo = TRUE)
# Filter the SMPDB enrichment set
SMPDBset_filtered <- filterEnrichmentSet(SMPDBset, hmdb_study)
load("./inst/exdata/smpdb_pathway.rda")
load("./inst/extdata/smpdb_pathway.rda")
SMPDBset <- as.EnrichmentSet.list(smpdb_pathway)
summary(SMPDBset)
hmdb_study <- unique(myProject_map$HMDB)
# Filter the SMPDB enrichment set
SMPDBset_filtered <- filterEnrichmentSet(SMPDBset, hmdb_study)
summary(SMPDBset_filtered)
SMPDBset_filtered<- as.data.frame(SMPDBset_filtered)
head(SMPDBset_filtered)
meta_df <- data.frame(
HMDB = c("HMDB0000060", "HMDB0000122", "HMDB0000209", "HMDB0000210"),
Pathway = c("Glycolysis", "Glycolysis", "TCA Cycle", "TCA Cycle")
)
Eset <- buildEnrichmentSet(
data = meta_df,
id_col = "HMDB",
category_col = "Pathway",
set_name = "SMPDB_pathways",
source = "SMPDB",
species = "Homo sapiens",
version = "2024-05",
description = "Metabolic pathways curated from SMPDB"
)
show(Eset)
summary(Eset)
as.data.frame(Eset)
devtools::load_all()
devtools::document()
pkgload::dev_help('filterEnrichmentSet')
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::document()
devtools::load_all()
detach("package::localEnrichment")
detach("package:localEnrichment")
devtools::load_all()
exists("as.EnrichmentSet.list")
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/R/EnrichmentSet-utils.R", echo = TRUE)
devtools::document()
devtools::check()
devtools::document()
remove.packages("localEnrichment")
remotes::install_github("aspresearch/localEnrichment")
library(localEnrichmentR)
library(localEnrichment)
ls("package:localEnrichment")
test_ES <- EnrichmentSet(
mapping = tibble(
set_id = "X",
set_name = "Test pathway",
feature_ids = "HMDB00001"
),
metadata = list(
mapping_name = "test",
feature_id_type = "HMDB",
feature_species = "human",
set_source = "manual",
version = "1.0",
description = "test"
),
sep = ";"
)
EnrichmentSet
ES_SMPDB_HMDB <- EnrichmentSet(
SMPDB_path2hmdb %>%
transmute(
set_id    = pathway,
set_name  = pathway,
feature_ids = HMDB
),
metadata = list(
mapping_name = "SMPDB_HMDB",
feature_id_type = "HMDB",
feature_species = "human",
set_source = "SMPDB",
version = "1.0",
description = "SMPDB pathways (HMDB IDs)"
),
sep = ";"
)
library(dplyr)
ES_SMPDB_HMDB <- EnrichmentSet(
SMPDB_path2hmdb %>%
transmute(
set_id    = pathway,
set_name  = pathway,
feature_ids = HMDB
),
metadata = list(
mapping_name = "SMPDB_HMDB",
feature_id_type = "HMDB",
feature_species = "human",
set_source = "SMPDB",
version = "1.0",
description = "SMPDB pathways (HMDB IDs)"
),
sep = ";"
)
devtools::load_all()
devtools::document()
devtools::load_all()
devtools::document()
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/0-test_EnrichmentSet-class.R", echo = TRUE)
meta <- list(
mapping_name = "smpdb_pathways",
feature_id_type = "HMDB_ID",
feature_species = "Homo sapiens",
set_source = "SMPDB",
version = "SMPDB v2.0 (2024-05)",
description = "Metabolic pathways curated from SMPDB"
)
sets <- data.frame(
set_id = c("PW001", "PW002"),
set_name = c("Glycolysis", "TCA Cycle"),
feature_ids = c("HMDB0000060;HMDB0000122", "HMDB0000209;HMDB0000210"),
description = c("Energy metabolism", "Mitochondrial cycle")
)
Eset <- EnrichmentSet(sets, meta)
show(Eset)
summary(Eset)
# Convert to list for ORA/QEA functions
sets_list <- as(Eset, "list")
str(sets_list)
# Coerce to data.frame
df <- as.data.frame(Eset)
head(df)
# Convert to list again
lst <- as(KEGGset, "list")
# Convert to list again
lst <- as(EnrichmentSet, "list")
length(lst)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/1-test_ora.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/2-test_plot_enrichment.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/3-test_qea.R", echo = TRUE)
meta <- list(
mapping_name = "chemical_classes",
feature_id_type = "HMDB_ID",
set_source = "MEGA",
version = "v2025.1",
description = "Chemical classes mapping"
)
sets <- data.frame(
set_id = c("CL001", "CL002", "CL003"),
set_name = c("Amino Acids", "Biogenic Amines", "Lipids"),
feature_ids = c(
"HMDB0000161;HMDB0000191;HMDB0000243;HMDB0000284",
"HMDB0001432;HMDB0001448;HMDB0001820",
"HMDB0000221;HMDB0000562;HMDB0000625;HMDB0000933"
)
Eset <- EnrichmentSet(sets, meta)
# Vector de scores (p.ex. correlacions o loadings)
scores <- c(
HMDB0000161 = 0.35, HMDB0000191 = 0.42,
HMDB0000243 = 0.12, HMDB0000284 = 0.29,
HMDB0001432 = -0.25, HMDB0001448 = -0.32,
HMDB0001820 = -0.18, HMDB0000221 = 0.10,
HMDB0000562 = 0.05, HMDB0000625 = -0.02,
HMDB0000933 = -0.11
)
res_qsea <- qea_test(Eset, scores, nperm = 1000)
qea_test
devtools::load_all()
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/R/qea_test.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/4-test_plot_qea_profile.R", echo = TRUE)
meta <- list(
mapping_name = "chemical_classes",
feature_id_type = "HMDB_ID",
set_source = "MEGA",
version = "v2025.1",
description = "Chemical classes mapping"
)
sets <- data.frame(
set_id = c("CL001", "CL002", "CL003"),
set_name = c("Amino Acids", "Biogenic Amines", "Lipids"),
feature_ids = c(
"HMDB0000161;HMDB0000191;HMDB0000243;HMDB0000284",
"HMDB0001432;HMDB0001448;HMDB0001820",
"HMDB0000221;HMDB0000562;HMDB0000625;HMDB0000933"
)
Eset <- EnrichmentSet(sets, meta)
scores <- c(
HMDB0000161 = 0.35, HMDB0000191 = 0.42,
HMDB0000243 = 0.12, HMDB0000284 = 0.29,
HMDB0001432 = -0.25, HMDB0001448 = -0.32,
HMDB0001820 = -0.18, HMDB0000221 = 0.10,
HMDB0000562 = 0.05, HMDB0000625 = -0.02,
HMDB0000933 = -0.11
)
qea_profile <- function(eset, scores, set_name) {
if (!inherits(eset, "EnrichmentSet")) stop("Input must be an EnrichmentSet.")
sets_list <- as(eset, "list")
if (!(set_name %in% names(sets_list)))
stop("Specified set_name not found in EnrichmentSet.")
hits <- sets_list[[set_name]]
df <- data.frame(
feature = names(sort(scores, decreasing = TRUE)),
score = sort(scores, decreasing = TRUE)
)
df$hit <- ifelse(df$feature %in% hits, 1, 0)
Nh <- sum(df$hit)
N <- nrow(df)
if (Nh == 0) stop("No hits for this set in scores.")
running_score <- cumsum(df$hit / Nh - (!df$hit) / (N - Nh))
data.frame(
position = seq_len(N),
running_score = running_score,
hit = df$hit
)
}
profile_df <- qea_profile(Eset, scores, set_name = "Amino Acids")
profile_df <- qea_profile(Eset, scores, set_name = set_name = "CL001")
q
profile_df <- qea_profile(Eset, scores, set_name = set_name = "CL001")
profile_df <- qea_profile(Eset, scores, set_name= "CL001")
p <- plot_qsea_profile(
profile_df,
set_name = "Amino Acids",
highlight = "#4E79A7",
rug_color = "black"
)
p <- plot_qea_profile(
profile_df,
set_name = "Amino Acids",
highlight = "#4E79A7",
rug_color = "black"
)
p <- plot_qea_profile(
profile_df,
set_name =  "CL001",
highlight = "#4E79A7",
rug_color = "black"
)
profile_df <- qea_profile(Eset, scores, set_name= "CL001")
p <- plot_qea_profile(
profile_df,
set_name =  "CL001",
highlight = "#4E79A7",
rug_color = "black"
)
p <- plot_qea_profile(
profile_df,
highlight = "#4E79A7",
rug_color = "black"
)
qea_profile <- function(eset, scores, set_name) {
if (!inherits(eset, "EnrichmentSet"))
stop("Input must be an EnrichmentSet.")
sets_list <- as(eset, "list")   # clau: set_id
# ðŸ‘‰ permetre noms humans
if (!(set_name %in% names(sets_list))) {
lookup <- eset@data
if (set_name %in% lookup$set_name) {
set_name <- lookup$set_id[match(set_name, lookup$set_name)]
} else {
stop("Specified set_name not found in EnrichmentSet.")
}
hits <- sets_list[[set_name]]
df <- data.frame(
feature = names(sort(scores, decreasing = TRUE)),
score = sort(scores, decreasing = TRUE)
)
df$hit <- df$feature %in% hits
Nh <- sum(df$hit)
N <- nrow(df)
if (Nh == 0) stop("No hits for this set in scores.")
running_score <- cumsum(df$hit / Nh - (!df$hit) / (N - Nh))
data.frame(
position = seq_len(N),
running_score = running_score,
hit = df$hit
)
}
profile_df <- qea_profile(Eset, scores, set_name= "CL001")
p <- plot_qea_profile(
profile_df,
highlight = "#4E79A7",
rug_color = "black"
)
p <- plot_qea_profile(
profile_df,
sets = "CL001",
highlight = "#4E79A7",
rug_color = "black"
)
profile_df <- qea_profile(Eset, scores, set_name = "CL001")
p <- plot_qea_profile(
profile_df,
sets = "CL001",
highlight = "#4E79A7",
rug_color = "black"
)
#' @param qea_res A \code{QEAResult} from \code{qea_test(return_profiles=TRUE)}.
#' @param sets Character vector of set names to display. If NULL, behavior depends on `show`.
#' @param show One of "significant", "selected", or "all".
#' @param p_cutoff Numeric; significance threshold for `show="significant"` (default 0.05).
#' @param facet Logical; facet by set (TRUE) or overlay curves (FALSE).
#' @param highlight Color for enrichment curves (used if overlaying).
#' @param rug_color Color for tick marks under each panel / curve.
#'
#' @return A ggplot object.
#' @export
plot_qea_profile <- function(x,
sets = NULL,
show = c("all", "selected", "significant"),
p_cutoff = 0.05,
facet = FALSE,
highlight = "#4E79A7",
rug_color = "black") {
show <- match.arg(show)
if (!inherits(x, "QEAResult"))
stop("x must be a QEAResult produced by qea_test(return_profiles=TRUE).")
profiles <- x$profiles
tbl <- x$table
# Convertir noms humans a set_id
if (!is.null(sets)) {
lookup <- tbl[, c("set_id", "set_name")]
sets <- sapply(sets, function(s) {
if (s %in% lookup$set_id) return(s)
if (s %in% lookup$set_name) return(lookup$set_id[match(s, lookup$set_name)])
stop(paste("Set", s, "not found."))
})
}
# Filtrar segons show
if (show == "significant")
sets <- tbl$set_id[tbl$p_adj <= p_cutoff]
if (show == "selected" && is.null(sets))
stop("You must supply 'sets' when show='selected'.")
df <- dplyr::bind_rows(profiles[sets], .id = "set_id")
df$set_name <- tbl$set_name[match(df$set_id, tbl$set_id)]
gg <- ggplot(df, aes(position, running_score, color = set_name)) +
geom_line(size = 1) +
geom_hline(yintercept = 0, linetype = "dashed") +
geom_rug(data = subset(df, hit == 1),
aes(position, running_score),
inherit.aes = FALSE,
sides = "b",
color = rug_color) +
labs(x = "Rank", y = "Running ES", color = "Set",
title = "QEA Running Score Profiles") +
theme_minimal(base_size = 12)
if (facet)
gg <- gg + facet_wrap(~ set_name, scales = "free_y")
gg
}
devtools::load_all()
rm(list=ls())
devtools::load_all()
devtools::document()
meta <- list(
mapping_name = "chemical_classes",
feature_id_type = "HMDB_ID",
set_source = "MEGA",
version = "v2025.1",
description = "Chemical classes mapping"
)
sets <- data.frame(
set_id = c("CL001", "CL002", "CL003"),
set_name = c("Amino Acids", "Biogenic Amines", "Lipids"),
feature_ids = c(
"HMDB0000161;HMDB0000191;HMDB0000243;HMDB0000284",
"HMDB0001432;HMDB0001448;HMDB0001820",
"HMDB0000221;HMDB0000562;HMDB0000625;HMDB0000933"
)
Eset <- EnrichmentSet(sets, meta)
scores <- c(
HMDB0000161 = 0.35, HMDB0000191 = 0.42,
HMDB0000243 = 0.12, HMDB0000284 = 0.29,
HMDB0001432 = -0.25, HMDB0001448 = -0.32,
HMDB0001820 = -0.18, HMDB0000221 = 0.10,
HMDB0000562 = 0.05, HMDB0000625 = -0.02,
HMDB0000933 = -0.11
)
qea_profile <- function(eset, scores, set_name) {
if (!inherits(eset, "EnrichmentSet"))
stop("Input must be an EnrichmentSet.")
sets_list <- as(eset, "list")   # clau: set_id
# ðŸ‘‰ permetre noms humans
if (!(set_name %in% names(sets_list))) {
lookup <- eset@data
if (set_name %in% lookup$set_name) {
set_name <- lookup$set_id[match(set_name, lookup$set_name)]
} else {
stop("Specified set_name not found in EnrichmentSet.")
}
hits <- sets_list[[set_name]]
df <- data.frame(
feature = names(sort(scores, decreasing = TRUE)),
score = sort(scores, decreasing = TRUE)
)
df$hit <- df$feature %in% hits
Nh <- sum(df$hit)
N <- nrow(df)
if (Nh == 0) stop("No hits for this set in scores.")
running_score <- cumsum(df$hit / Nh - (!df$hit) / (N - Nh))
data.frame(
position = seq_len(N),
running_score = running_score,
hit = df$hit
)
}
profile_df <- qea_profile(Eset, scores, set_name = "CL001")
p <- plot_qea_profile(
profile_df,
sets = "CL001",
highlight = "#4E79A7",
rug_color = "black"
)
Eset_small <- filter_sets_by_features(Eset, names(scores))
# 2. QEA complet amb perfils
res_qea <- qea_test(Eset_small, scores,
min_set_size = 2,
return_profiles = TRUE,
nperm = 1000)
# 3. Plot per un set concret (per ID)
plot_qea_profile(res_qea, sets = "CL001")
library(ggplot2)
# 3. Plot per un set concret (per ID)
plot_qea_profile(res_qea, sets = "CL001")
# O per nom humÃ :
plot_qea_profile(res_qea, sets = "Amino Acids")
# 4. Tots els significatius
plot_qea_profile(res_qea, show = "significant", p_cutoff = 0.25)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/5-test_prepare_features_list.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/6-test_buildEnrichmentSet.R", echo = TRUE)
meta_df <- data.frame(
HMDB = c("HMDB0000060", "HMDB0000122", "HMDB0000209", "HMDB0000210"),
Pathway = c("Glycolysis", "Glycolysis", "TCA Cycle", "TCA Cycle")
)
Eset <- buildEnrichmentSet(
data = meta_df,
id_col = "HMDB",
category_col = "Pathway",
set_name = "SMPDB_pathways",
source = "SMPDB",
species = "Homo sapiens",
version = "2024-05",
description = "Metabolic pathways curated from SMPDB"
)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/R/EnrichmentSet-class.R", echo = TRUE)
devtools::load_all()
rm(list=ls())
devtools::load_all()
devtools::document()
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/0-test_EnrichmentSet-class.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/1-test_ora.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/2-test_plot_enrichment.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/dev/3-test_qea.R", echo = TRUE)
source("C:/Users/Usuario/Dropbox (Personal)/SotaCV/localEnrichment/R/EnrichmentSet-methods.R", echo = TRUE)
meta_df <- data.frame(
HMDB = c("HMDB0000060", "HMDB0000122", "HMDB0000209", "HMDB0000210"),
Pathway = c("Glycolysis", "Glycolysis", "TCA Cycle", "TCA Cycle")
)
Eset <- buildEnrichmentSet(
data = meta_df,
id_col = "HMDB",
category_col = "Pathway",
set_name = "SMPDB_pathways",
source = "SMPDB",
species = "Homo sapiens",
version = "2024-05",
description = "Metabolic pathways curated from SMPDB"
)
show(Eset)
summary(Eset)
as.data.frame(Eset)
load(file="./inst/extdata/myProject_map.Rda")
head(myProject_map[,1:6])
# 1ï¸âƒ£ KEGG-based enrichment
KEGGset <- buildEnrichmentSet(
data = myProject_map,
id_col = "HMDB",
category_col = "KEGG",
set_name = "KEGG_pathways",
source = "MetaboAnalyst mapping"
)
metabsChemicalClasses<- openxlsx::read.xlsx("./inst/extdata/MEGA-r_name-HMDB-ChemicalClasses.xlsx")
# 2ï¸âƒ£ Chemical classes enrichment
ChemClassSet <- buildEnrichmentSet(
data = metabsChemicalClasses,
id_col = "HMDB",
category_col = "ChemicalClass",
set_name = "ChemicalClasses",
source = "MEGA annotation"
)
# 3ï¸âƒ£ Visualitzar resum
summary(KEGGset)
summary(ChemClassSet)
load("./inst/extdata/smpdb_pathway.rda")
SMPDBset <- as.EnrichmentSet.list(smpdb_pathway)
summary(SMPDBset)
hmdb_study <- unique(myProject_map$HMDB)
# Filter the SMPDB enrichment set
SMPDBset_filtered <- filterEnrichmentSet(SMPDBset, hmdb_study)
summary(SMPDBset_filtered)
SMPDBset_filtered<- as.data.frame(SMPDBset_filtered)
head(SMPDBset_filtered)
rm(list=ls())
devtools::load_all()
devtools::document()
devtools::load_all()
devtools::document()
q()
